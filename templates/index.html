<!DOCTYPE html>
<html>
<head>
    <title>School Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f9; margin: 0; }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: #2c3e50; display:flex; justify-content:center; align-items:center; z-index:1000; }
        .login-card { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 320px; text-align: center; }
        .dashboard { display: none; padding: 30px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; border-bottom: 1px solid #eee; text-align: center; }
        th { background: #34495e; color: white; }
        .pie-box { width: 350px; margin: 20px auto; }
        .status-pass { color: green; font-weight: bold; }
        .status-fail { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div id="loginOverlay" class="overlay">
    <div class="login-card">
        <h2>Portal Login</h2>
        <input type="text" id="uName" placeholder="Username">
        <input type="password" id="uPass" placeholder="Password">
        <button onclick="doLogin()">Login</button>
        <p style="font-size: 11px; color: #7f8c8d; margin-top: 15px;">Teacher: admin / admin | Student: Name / 1234</p>
    </div>
</div>

<div id="teacherView" class="dashboard">
    <h1 style="color: #2c3e50;">üë®‚Äçüè´ Teacher Dashboard</h1>
    <div class="card">
        <h3>Add New Entry</h3>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="n" placeholder="Name">
            <input type="number" id="m" placeholder="Math">
            <input type="number" id="s" placeholder="Science">
            <input type="number" id="e" placeholder="English">
            <button onclick="saveData()" style="width: 200px;">Save Result</button>
        </div>
    </div>
    <div class="card">
        <h3>Rank List & Records</h3>
        <table id="tTable">
            <thead><tr><th>Name</th><th>Total</th><th>%</th><th>Grade</th><th>Status</th><th>Action</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="studentView" class="dashboard">
    <h1 style="color: #2c3e50;">üéì Student Report Card</h1>
    <div class="card" style="text-align: center;">
        <h2 id="sWelcome"></h2>
        <div id="sMeta" style="font-size: 20px; margin: 20px 0;"></div>
        <div class="pie-box"><canvas id="sChart"></canvas></div>
        <button onclick="location.reload()" style="background:#95a5a6; width: 150px;">Logout</button>
    </div>
</div>

<script>
    function doLogin() {
        const name = document.getElementById('uName').value;
        const password = document.getElementById('uPass').value;
        fetch('/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, password})
        }).then(r => r.json()).then(res => {
            if(res.role === 'teacher') {
                document.getElementById('loginOverlay').style.display='none';
                document.getElementById('teacherView').style.display='block';
                loadAll();
            } else if(res.role === 'student') {
                document.getElementById('loginOverlay').style.display='none';
                document.getElementById('studentView').style.display='block';
                showReport(res.data);
            } else { alert(res.message); }
        });
    }

    function showReport(d) {
        document.getElementById('sWelcome').innerText = "Performance Summary: " + d.name;
        document.getElementById('sMeta').innerHTML = `
            Percentage: <b>${d.percentage}%</b> | Grade: <b>${d.grade}</b> | 
            Status: <span class="${d.status=='Pass'?'status-pass':'status-fail'}">${d.status}</span>
        `;
        new Chart(document.getElementById('sChart'), {
            type: 'pie',
            data: {
                labels: ['Math', 'Science', 'English'],
                datasets: [{ data: [d.math, d.science, d.english], backgroundColor: ['#3498db', '#2ecc71', '#e74c3c'] }]
            }
        });
    }

    function loadAll() {
        fetch('/get_all').then(r => r.json()).then(data => {
            const b = document.querySelector('#tTable tbody');
            b.innerHTML = data.map(i => `
                <tr>
                    <td>${i.name}</td><td>${i.total}</td><td>${i.percentage}%</td><td>${i.grade}</td>
                    <td class="${i.status=='Pass'?'status-pass':'status-fail'}">${i.status}</td>
                    <td><button onclick="del(${i.id})" style="background:#e74c3c; padding: 5px 10px;">Delete</button></td>
                </tr>
            `).join('');
        });
    }

    function saveData() {
        const payload = {
            name: document.getElementById('n').value,
            math: document.getElementById('m').value,
            science: document.getElementById('s').value,
            english: document.getElementById('e').value
        };
        fetch('/add_result', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(() => { alert("Saved!"); loadAll(); });
    }

    function del(id) {
        if(confirm("Are you sure?")) fetch('/delete/'+id, {method:'DELETE'}).then(() => loadAll());
    }
</script>
</body>
</html>